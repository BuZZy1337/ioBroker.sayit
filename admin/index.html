<html>

<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="engines.js"></script>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<style>
    #drop_zone{
        border: 2px dashed #bbb;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        padding: 25px;
        text-align: center;
        font-size: 20pt;
        font-weight: bold;
        font-family:  'Arial';
        color: #bbb;
        width: 90%;
        height: 60px;
    }
</style>
<script type="text/javascript">
    systemDictionary = {
        "sayIt adapter settings": {
            "de": "sayIt Einstellungen",
            "ru": "sayIt Настройки"
        },
        "Language:":        {"en": "Language:",         "de": "Sprache:",       "ru": "Язык:"},
        "Type:":            {"en": "Output in:",        "de": "Ausgabe durch:", "ru": "Вывод звука:"},
        "Cache:":           {"en": "Cache received audio files:",            "de": "Cache benutzen:",         "ru": "Кэшировать полученные аудио-файлы:"},
        "Server:":          {"en": "Server:",           "de": "Server:",        "ru": "Сервер:"},
        "Port:":            {"en": "Port:",             "de": "Port:",          "ru": "Порт:"},
        "User:":            {"en": "User:",             "de": "Anwender:",      "ru": "Пользователь:"},
        "Password:":        {"en": "Password:",         "de": "Kennwort:",      "ru": "Пароль:"},
        "Browser instance:": {"en": "Browser instance:", "de": "Browser-Instanz:", "ru": "ID броузера:"},
        "Device:":          {"en": "Device:",           "de": "Gerät:",         "ru": "Устройство:"},
        "Web server IP:":   {"en": "Web server IP:",    "de": "Web server IP:", "ru": "IP Веб сервера:"},
        "All":              {"en": "All",               "de": "Alle",           "ru": "Все"},
        "Web instance:":    {"en": "Web instance:",     "de": "Web instance:",  "ru": "Web instance:"},
        "Voice:":           {"en": "Voice:",            "de": "Stimme:",        "ru": "Голос:"},
        "API Key:":         {"en": "API Key:",          "de": "API Key:",       "ru": "API Key:"},
        "Emotion:":         {"en": "Emotion:",          "de": "Emotion:",       "ru": "Емоциональный окрас:"},
        "Drunk:":           {"en": "Drunk:",            "de": "Betrunken:",     "ru": "Пьяный голос:"},
        "Ill:":             {"en": "Ill:",              "de": "Krank:",         "ru": "Больной голос:"},
        "Robot:":           {"en": "Robot:",            "de": "Roboter:",       "ru": "Голос робота:"},
        "Announce:":        {"en": "Announce:",         "de": "Ankündigung:",   "ru": "Извещение:"},
        "Announce timeout (sec):": {
            "en": "Announce timeout (sec):",
            "de": "Ankündigungstimeout (Sek):",
            "ru": "Таймаут извещения (сек):"
        },
        "Announce length (sec):": {"en": "Announce length (sec):", "de": "Ankündigunglänge (Sek):", "ru": "Длительность извещения (сек):"},
        "API Key is not set!": {"en": "API Key is not set!", "de": "API Key ist leer!", "ru": "API Key отсутствует!"},
        "System command:":  {"en": "System command:",   "de": "Systemkommando:", "ru": "Системный вызов:"},
        "Announce volume (%):": {"en": "Announce volume(%):", "de": "Ankündigungslautstärke(%):", "ru": "Громкость извещения(%):"},
        "Linux player:":    {"en": "Linux player:",     "de": "Linux-Player:", "ru": "Linux плейер:"},
        "Ignore for non linux OS": {"en": "Ignore for non linux OS", "de": "Ignorieren für nicht linux OS", "ru": "Игнорировать для не linux OS"},
        "Access Key:":      {"en": "Access Key:", "de": "Access Key:", "ru": "Access Key:"},
        "Secret Key:":      {"en": "Secret Key:", "de": "Secret Key:", "ru": "Secret Key:"}
    };

    var webServers = null;

    function showHideSettings() {
        $('.variable').hide();
        var type = $('#type').val();
        for (var i = 0; i < sayitOptions[type].params.length; i++) {
            $('#tr_' + sayitOptions[type].params[i]).show();
        }

        $('.engine').hide();
        var engine = $('#engine').val();

        if (!sayitEngines[engine]) return;

        for (var i = 0; i < sayitEngines[engine].params.length; i++) {
            $('#tr_' + sayitEngines[engine].params[i]).show();
            if (sayitEngines[engine][sayitEngines[engine].params[i]]) {
                var arr = sayitEngines[engine][sayitEngines[engine].params[i]];
                var param = sayitEngines[engine].params[i];

                if (arr.length) {
                    var val = $('#' + param).val();
                    var text = '';
                    for (var j = 0; j < arr.length; j++) {
                        text += '<option value="' + arr[j] + '">' + arr[j] + '</option>';
                    }
                    $('#' + param).html(text);
                    if (val) {
                        $('#' + param).val(val);
                    } else {
                        $('#' + param).val(arr[0]);
                    }
                } else {
                    $('#' + param).html('');
                }
            }
        }
        if (type != 'system') {
            $('.system').hide();
        }  else {
            $('.system').show();
        }

        if (!$('#announce').val()) {
            $('.announce').hide();
            $('#play').button('disable');
        } else {
            $('.announce').show();
            $('#play').button('enable');
        }
    }

    function fillSonosDevices(elem, current) {
        socket.emit('getObjectView', 'system', 'channel', {startkey: 'sonos.', endkey: 'sonos.\u9999'}, function (err, res) {
            if (!err && res) {
                for (var i = 0; i < res.rows.length; i++) {
                    $(elem).append('<option value="' + res.rows[i].id + '">' + res.rows[i].id + '</option>');
                }
            }
            $(elem).val(current);
        });
    }
    
    function fillmpd_device(elem, current) {
        socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.mpd.', endkey: 'system.adapter.mpd.\u9999'}, function (err, res) {
            if (!err && res) {
                for (var i = 0; i < res.rows.length; i++) {
					var n =  res.rows[i].id.replace('system.adapter.', '');
                    $(elem).append('<option value="' + n + '">' + n + '</option>');
                }
            }
            $(elem).val(current);
        });
    }

    function fillChromecastDevices(elem, current) {
        socket.emit('getObjectView', 'system', 'device', {startkey: 'chromecast.', endkey: 'chromecast.\u9999'}, function (err, res) {
            if (!err && res) {
                for (var i = 0; i < res.rows.length; i++) {
                    $(elem).append('<option value="' + res.rows[i].id + '">' + res.rows[i].id + '</option>');
                }
            }
            $(elem).val(current);
        });
    }

    function checkWeb(elem, current) {
        var web = $('#web').val();
        for (var i = 0; i < webServers.length; i++) {
            if (webServers[i].id == 'system.adapter.' + web) {
                if (webServers[i].value.native.auth) {
                    showMessage(_('Cannot use web server with authentication'), null, 'info');
                }
                if (webServers[i].value.native.bind == 'localhost' || webServers[i].value.native.bind == '127.0.0.1' || webServers[i].value.native.bind == '::1') {
                    showMessage(_('Cannot use web server only on localhost'), null, 'info');
                }

                if (webServers[i].value.native.bind == '0.0.0.0') {
                    $('#tr_webServer').show();
                    $('#webServer').html('');
                    // read all ipv4 addresses of host
                    socket.emit('getObject', 'system.host.' + webServers[i].value.common.host, function (err, obj) {
                        if (!err && obj && obj.native) {
                            for (var iface in obj.native.hardware.networkInterfaces) {
                                for (var i = 0; i < obj.native.hardware.networkInterfaces[iface].length; i++) {
                                    if (obj.native.hardware.networkInterfaces[iface][i].family == "IPv4" && !obj.native.hardware.networkInterfaces[iface][i].internal) {
                                        $('#webServer').append('<option value="' + obj.native.hardware.networkInterfaces[iface][i].address + '">[IPv4] ' + obj.native.hardware.networkInterfaces[iface][i].address + ' - ' + iface + '</option>');
                                    }
                                }
                            }
                        }

                        if (current)  $('#webServer').val(current);
                    });
                } else if (webServers[i].value.native.bind == '::') {
                    // read all ipv6 addresses of host
                    socket.emit('getObject', 'system.host.' + webServers[i].value.common.host, function (err, obj) {
                        if (!err && obj && obj.native) {
                            for (var iface in obj.native.hardware.networkInterfaces) {
                                for (var i = 0; i < obj.native.hardware.networkInterfaces[iface].length; i++) {
                                    if (obj.native.hardware.networkInterfaces[iface][i].family == "IPv6" && !obj.native.hardware.networkInterfaces[iface][i].internal) {
                                        $('#webServer').append('<option value="' + obj.native.hardware.networkInterfaces[iface][i].address + '">[IPv6] ' + obj.native.hardware.networkInterfaces[iface][i].address + ' - ' + iface + '</option>');
                                    }
                                }
                            }
                        }
                        if (current)  $('#webServer').val(current);
                    });
                } else {
                    $('#tr_webServer').hide();
                }
            }
        }
    }

    function fillWebServices(elem, current, type, webServer) {
        socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.web.', endkey: 'system.adapter.web.\u9999'}, function (err, res) {
            if (!err && res) {
                webServers = res.rows;
                for (var i = 0; i < res.rows.length; i++) {
                    var n =  res.rows[i].id.replace('system.adapter.', '');
                    var auth =  res.rows[i].value.native.auth ? 'data-auth="true"' : '';
                    $(elem).append('<option value="' + n + '" ' + auth + '>' + n + '</option>');
                }
            }
            $(elem).val(current);
            if ((type == 'sonos') ||
                (type == 'chromecast')) {
                checkWeb('#web', webServer);
            }
        });
    }

    function uploadFile(file, callback) {
        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = function(e) {
            socket.emit('writeFile', 'sayit.' + instance, 'tts.userfiles/' + file.name, e.target.result, function () {
                if (callback) callback(file.name);
            });
        };

        // Read in the image file as a data URL.
        reader.readAsArrayBuffer(file);
    }

    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        $('#drop_indcator').hide();

        // files is a FileList of File objects. List some properties.
        var count = 0;
        for (var i = 0, f; f = files[i]; i++) {
            if (f.size > 1024 * 1024) {
                showMessage(_('File %s is too big. Maximum 1MB', escape(f.name)));
                $('#files').val('');
                return;
            }
            if (f.name == 'say.mp3') {
                showMessage(_('Name say.mp3 is reserved'));
                $('#files').val('');
                return;
            }
            count++;
            uploadFile(f, function (name) {
                count--;
                if (!count) {
                    // Read names of files for gong
                    socket.emit('readDir', 'sayit.' + instance, 'tts.userfiles', function (err, dir) {
                        var text = '<option value="">' + _('none') + '</option>';
                        if (dir) {
                            for (var i = 0; i < dir.length; i++) {
                                if (dir[i].isDir) continue;
                                text += '<option value="' + dir[i].file + '">' + dir[i].file + '</option>';
                            }
                        }
                        $('#announce').html(text).val(name).trigger('change');
                        $('#files').val('');
                    });
                }
            });

        }
    }

    function handleFileSelectDrop(evt) {
        $('#drop_indcator').hide();
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.

        // files is a FileList of File objects. List some properties.
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            if (f.size > 1024 * 1024) {
                showMessage(_('File %s is too big. Maximum 1MB', escape(f.name)));
                return;
            }
            console.log(escape(f.name));
        }
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        $('#drop_indcator').show();
    }

    // the function loadSettings has to exist ...
    function load(settings, onChange) {
        if (!settings) return;

        if (!settings.player) settings.player = 'mpg321';

        $('#play').button({icons: {primary: 'ui-icon-play'}, text: false}).css({width: 22, height: 22}).click(function () {
            socket.emit('readFile', 'sayit.' + instance, 'tts.userfiles/' + $('#announce').val(), function (err, data) {
                if (typeof AudioContext != 'undefined') {
                    context = new AudioContext();
                    context.decodeAudioData(data, function(buffer) {
                        //console.log(buffer);
                        var source = context.createBufferSource(); // creates a sound source
                        source.buffer = buffer;                    // tell the source which sound to play
                        source.connect(context.destination);       // connect the source to the context's destination (the speakers)
                        source.start(0);
                    }, function(err) {
                        console.log(err);
                    });
                }
            });
        });

        var $t = $('#type');
        for (name in sayitOptions) {
            $t.append('<option value="' + name + '">' + sayitOptions[name].name + '</option>');
        }

        var $e = $('#engine');
        for (var name in sayitEngines) {
            $e.append('<option value="' + name + '">' + sayitEngines[name].name + '</option>');
        }
        for (var key in settings) {
            if ($('#' + key + '.value').attr('type') == 'checkbox') {
                $('#' + key + '.value').prop('checked', settings[key]);
            } else {
                $('#' + key + '.value').val(settings[key]);
            }
        }
        $('.value').each(function () {
            $(this).change(function() {
                var key = $(this).attr('id');

                if (key == 'auth' && $('#auth').prop('checked')) $('#secure').prop('checked', true);

                if (key == 'type' || key == 'engine') {
                    showHideSettings();

                    if (($('#type').val() == 'sonos') ||
                        ($('#type').val() == 'chromecast') ||
                        ($('#type').val() == 'mpd')) {
                        checkWeb('#web');
                        $('#announce').val('').trigger('change');
                        showHideSettings();
                    } else {
                        showHideSettings();
                    }
                }

                if (key == 'announce') {
                    showHideSettings();
                    if ($(this).val()) {
                        socket.emit('readFile', 'sayit.' + instance, 'tts.userfiles/' + $('#announce').val(), function (err, data) {
                            if (typeof AudioContext != 'undefined') {
                                context = new AudioContext();
                                context.decodeAudioData(data, function(buffer) {
                                    $('#annoDuration').val(Math.ceil(buffer.duration));
                                }, function(err) {
                                    console.log(err);
                                });
                            }
                        });
                    }
                }

                if (key == 'web') checkWeb('#web');
                onChange();
            }).keyup(function() {
                $(this).trigger('change');
            });
        });

        if (!settings.engine) {
            settings.engine = systemLang;
            $('#engine').val(systemLang).trigger('change');
        }
        if (!settings.instance) {
            settings.instance = 'FFFFFFFF';
            $('#instance').val(settings.instance).trigger('change');
        }

        fillSonosDevices('#device', settings.device);
        fillChromecastDevices('#cDevice', settings.cDevice);
        fillWebServices('#web', settings.web, settings.type, settings.webServer);
        fillmpd_device('#mpd_device', settings.mpd_device);

        if ((settings.type === 'sonos') ||
            (settings.type === 'chromecast') ||
            (settings.type === 'mpd')){
            $('.announce').hide();
            if (settings.announce) {
                $('#announce').val('').trigger('change');
            }
        }
        // Read names of files for gong
        socket.emit('readDir', 'sayit.' + instance, 'tts.userfiles', function (err, dir) {
            var text = '<option value="">' + _('none') + '</option>';
            if (dir) {
                for (var i = 0; i < dir.length; i++) {
                    if (dir[i].isDir) continue;
                    text += '<option value="' + dir[i].file + '">' + dir[i].file + '</option>';
                }
            }
            $('#announce').html(text).val(settings.announce);
            showHideSettings();
        });

        getAdapterInstances('cloud', function (list) {
            if (list) {
                var text = '';
                for (var i = 0; i < list.length; i++) {
                    var id = list[i]._id.substring('system.adapter.'.length);
                    text += '<option value="' + id + '" ' + (id === settings.cloud ? 'selected' : '') + '>' + id + '</option>';
                }
                if (text) $('#cloud').html(text);
            }
        });

        $('#voice').val(settings.voice);
        var w = $('#engine').width();
        $('#announce').css({width: w});
        $('#type').css({width: w});


        document.getElementById('files').addEventListener('change', handleFileSelect, false);
        showHideSettings();

        if (!$('#announce').val()) $('#play').button('disable');
        if (typeof AudioContext == 'undefined') $('#play').hide();

        var dropZone = document.getElementById('drop_zone');
        if (dropZone) {
            dropZone.addEventListener('dragover', handleDragOver,   false);
            dropZone.addEventListener('drop',     handleFileSelect, false);
            /*dropZone.addEventListener('dragend',  function () {
             $(this).css({background: 'white'});
             console.log('dragend');
             return false;
             }, false);
             dropZone.addEventListener('dragstart', function () {
             console.log('dragstart');
             }, false);
             dropZone.addEventListener('dragleave',  function () {
             $(this).css({background: 'white'});
             }, false);
             dropZone.addEventListener('dragenter', function () {
             $(this).css({background: 'gray'});
             }, false);*/
        }

        onChange(false);
    }

    // ... and the function save has to exist.
    // you have to make sure the callback is called with the settings object as first param!
    function save(callback) {
        // example: select elements with class=value and build settings object
        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') == 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });

        if (obj.engine && sayitEngines[obj.engine].engine == 'yandex') {
            if (!obj.key) {
                showMessage(_('API Key is not set!'));
                return;
            }
        } else
        if (obj.engine && sayitEngines[obj.engine].engine == 'ivona') {
            if (!obj.accessKey || !obj.secretKey) {
                showMessage(_('API Key is not set!'));
                return;
            }
        } else
        if (obj.engine && sayitEngines[obj.engine].engine == 'polly') {
            if (!obj.accessKey || !obj.secretKey) {
                showMessage(_('API Key is not set!'));
                return;
            }
            if (!obj.region) {
                showMessage(_('AWS Region is not set!'));
                return;
            }
        }

        callback(obj);
    }
</script>

<!-- you have to put your config page in a div with id adapter-container -->
<div id="adapter-container" ondragover="return false" drop="return false">

    <table><tr><td><img src="sayit.png"></td><td><h3 class="translate">sayIt adapter settings</h3></td></tr></table>

    <div>
        <table>
            <tr><td class="translate" style="width: 150px">Language:</td><td><select class="value" id="engine"></select></td></tr>
            <tr><td class="translate">Type:</td><td><select class="value" id="type"></select></td></tr>
            <tr class="system"><td><label for="player" class="translate">Linux player:</label></td><td>
                <select class="value" id="player" >
                    <option value="mpg321">mpg321</option>
                    <option value="omxplayer">omxplayer</option>
                </select><span class="translate" style="padding-left: 10px; font-size: 10px">Ignore for non linux OS</span>
            </td>
            </tr>
            <tr class="system"><td class="translate">System command:</td><td><input class="value" id="command"/></td></tr>
            <tr class="announceValue"><td class="translate">Announce:</td><td><select class="value" id="announce"></select>&nbsp;<button id="play"></button></td></tr>
            <tr class="announceValue"><td></td><td><input type="file" accept=".mp3,audio/*" id="files" name="files[]" multiple /></td></tr>
            <tr class="announce"><td class="translate">Announce timeout (sec):</td><td><input class="value" id="annoTimeout" type="text" size="8" /></td></tr>
            <tr class="announce"><td class="translate">Announce length (sec):</td><td><input class="value" id="annoDuration" type="text" size="2" /></td></tr>
            <tr class="announce"><td class="translate">Announce volume (%):</td><td><input class="value" id="annoVolume" type="text" size="3" /></td></tr>
            <tr><td>&nbsp;</td><td>&nbsp;</td></tr>

            <tr id="tr_cache"      class="variable"><td class="translate">Cache:</td>   <td><input class="value" id="cache"   type="checkbox" /></td></tr>
            <tr id="tr_server"     class="variable"><td class="translate">Server:</td>  <td><input class="value" id="server"  type="text" /></td></tr>
            <tr id="tr_port"       class="variable"><td class="translate">Port:</td>    <td><input class="value" id="port"    type="text"size="5"  maxlength="5"/></td></tr>
            <tr id="tr_user"       class="variable"><td class="translate">User:</td>    <td><input class="value" id="user"    type="text" /></td></tr>
            <tr id="tr_pass"       class="variable"><td class="translate">Password:</td><td><input class="value" id="pass"    type="text" /></td></tr>
            <tr id="tr_instance"   class="variable"><td class="translate">Browser instance:</td><td><input class="value" id="instance" type="text" /></td></tr>
            <tr id="tr_device"     class="variable"><td class="translate">Device:</td><td><select class="value" id="device"><option value="" class="translate">All</option></select></td></tr>
            <tr id="tr_cDevice"    class="variable"><td class="translate">Device:</td><td><select class="value" id="cDevice"><option value="" class="translate">All</option></select></td></tr>
            <tr id="tr_mpd_device" class="variable"><td class="translate">Device:</td><td><select class="value" id="mpd_device"><option value="" class="translate">All</option></select></td></tr>
            <tr id="tr_web"        class="variable"><td class="translate">Web instance:</td><td><select class="value" id="web"></select></td></tr>
            <tr id="tr_webServer"  class="variable"><td class="translate">Web server IP:</td><td><select class="value" id="webServer"></select></td></tr>
            <tr id="tr_voice"      class="engine"  ><td class="translate">Voice:</td><td><select class="value" id="voice"></select></td></tr>
            <tr id="tr_key"        class="engine"  ><td class="translate">API Key:</td><td><input class="value" id="key" type="text"/></td></tr>
            <tr id="tr_emotion"    class="engine"  ><td class="translate">Emotion:</td><td><select class="value" id="emotion"></select></td></tr>
            <tr id="tr_drunk"      class="engine"  ><td class="translate">Drunk:</td><td><input type="checkbox" class="value" id="drunk"/></td></tr>
            <tr id="tr_ill"        class="engine"  ><td class="translate">Ill:</td><td><input type="checkbox" class="value" id="ill"/></td></tr>
            <tr id="tr_robot"      class="engine"  ><td class="translate">Robot:</td><td><input type="checkbox" class="value" id="robot"/></td></tr>
            <tr id="tr_accessKey"  class="engine"  ><td class="translate">Access Key:</td><td><input class="value" id="accessKey" type="text"/></td></tr>
            <tr id="tr_secretKey"  class="engine"  ><td class="translate">Secret Key:</td><td><input class="value" id="secretKey" type="password"/></td></tr>
            <tr id="tr_region"     class="engine"  ><td class="translate">AWS Region:</td><td><input class="value" id="region" type="text"/></td></tr>
            <tr id="tr_cloud"      class="engine"  ><td class="translate">Cloud instance:</td><td><select class="value" id="cloud"><option value="" class="translate">Install first cloud adapter</option></select></td></tr>
        </table>
    </div>
    <div id="drop_zone" style="display: none">Dateien hier ablegen</div>
</div>
</html>
